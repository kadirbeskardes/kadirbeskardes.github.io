@page "/admin/dashboard"
@using Personal.Models
@using Personal.Services
@using Microsoft.AspNetCore.Components.Forms
@inject AdminService AdminService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Admin Dashboard</PageTitle>

@if (!isAuthenticated)
{
    <div class="loading-wrapper">
        <div class="spinner-large"></div>
    </div>
}
else
{
    <div class="admin-dashboard">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <h1><i class="bi bi-grid-3x3-gap me-2"></i>Proje Yönetimi</h1>
            </div>
            <div class="header-center">
                <div class="session-info">
                    <i class="bi bi-clock me-1"></i>
                    <span>Oturum: @remainingMinutes dk</span>
                    @if (remainingMinutes <= 10)
                    {
                        <button class="extend-btn" @onclick="ExtendSession" title="Oturumu Uzat">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    }
                </div>
            </div>
            <div class="header-right">
                <button class="btn-secondary" @onclick="ExportJson">
                    <i class="bi bi-download me-2"></i>JSON D??a Aktar
                </button>
                <button class="btn-secondary" @onclick="ResetProjects">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>S?f?rla
                </button>
                <button class="btn-danger" @onclick="Logout">
                    <i class="bi bi-box-arrow-right me-2"></i>Ç?k??
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Actions Bar -->
            <div class="actions-bar">
                <button class="btn-primary" @onclick="ShowAddModal">
                    <i class="bi bi-plus-lg me-2"></i>Yeni Proje Ekle
                </button>
                <span class="project-count">
                    <i class="bi bi-folder2 me-2"></i>@(projects?.Count ?? 0) proje
                </span>
            </div>

            <!-- Projects Table -->
            @if (projects == null)
            {
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Projeler yükleniyor...</p>
                </div>
            }
            else if (!projects.Any())
            {
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3>Henüz proje yok</h3>
                    <p>Yeni bir proje ekleyerek ba?lay?n.</p>
                </div>
            }
            else
            {
                <div class="table-container">
                    <table class="projects-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ba?l?k</th>
                                <th>Kategori</th>
                                <th>Tarih</th>
                                <th>??lemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in projects.OrderByDescending(p => p.Id))
                            {
                                <tr>
                                    <td class="id-cell">@project.Id</td>
                                    <td class="title-cell">
                                        <div class="project-info">
                                            @if (!string.IsNullOrEmpty(project.ImageUrl))
                                            {
                                                <img src="@project.ImageUrl" alt="@project.Title" class="project-thumb" />
                                            }
                                            <span>@project.Title</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="category-badge">@project.Category</span>
                                    </td>
                                    <td>@project.CreatedDate.ToString("dd.MM.yyyy")</td>
                                    <td class="actions-cell">
                                        <button class="btn-icon edit" @onclick="() => ShowEditModal(project)" title="Düzenle">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn-icon delete" @onclick="() => DeleteProject(project.Id)" title="Sil">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </main>

        <!-- Modal -->
        @if (showModal)
        {
            <div class="modal-overlay" @onclick="CloseModal">
                <div class="modal-content" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <h2>@(isEditing ? "Proje Düzenle" : "Yeni Proje Ekle")</h2>
                        <button class="modal-close" @onclick="CloseModal">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Ba?l?k *</label>
                                <input type="text" @bind="currentProject.Title" placeholder="Proje ba?l???" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>K?sa Aç?klama *</label>
                                <textarea @bind="currentProject.ShortDescription" rows="2" placeholder="K?sa aç?klama"></textarea>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Detayl? Aç?klama</label>
                                <textarea @bind="currentProject.FullDescription" rows="4" placeholder="Detayl? aç?klama"></textarea>
                            </div>
                        </div>

                        <div class="form-row two-col">
                            <div class="form-group">
                                <label>Kategori</label>
                                <input type="text" @bind="currentProject.Category" placeholder="Örn: Web Uygulamas?" />
                            </div>
                            <div class="form-group">
                                <label>GitHub URL</label>
                                <input type="text" @bind="currentProject.GitHubUrl" placeholder="https://github.com/..." />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Proje URL</label>
                                <input type="text" @bind="currentProject.ProjectUrl" placeholder="https://..." />
                            </div>
                        </div>

                        <!-- Görsel Yükleme Bölümü -->
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="bi bi-image me-2"></i>Proje Görseli</label>
                                <div class="image-upload-container">
                                    @if (!string.IsNullOrEmpty(imagePreview) || !string.IsNullOrEmpty(currentProject.ImageUrl))
                                    {
                                        <div class="image-preview-wrapper">
                                            <img src="@(imagePreview ?? currentProject.ImageUrl)" alt="Proje Görseli" class="image-preview" />
                                            <button type="button" class="remove-image-btn" @onclick="RemoveImage" title="Görseli Kald?r">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    }
                                    <div class="upload-area @(isUploading ? "uploading" : "")">
                                        <InputFile OnChange="HandleImageUpload" accept="image/*" class="file-input" id="imageUpload" disabled="@isUploading" />
                                        <label for="imageUpload" class="upload-label">
                                            @if (isUploading)
                                            {
                                                <div class="upload-spinner"></div>
                                                <span>Yükleniyor...</span>
                                            }
                                            else
                                            {
                                                <i class="bi bi-cloud-arrow-up"></i>
                                                <span>Görsel Yükle</span>
                                                <small>PNG, JPG, GIF (Maks. 5MB)</small>
                                            }
                                        </label>
                                    </div>
                                    <div class="image-url-input">
                                        <span class="or-divider">veya URL girin</span>
                                        <input type="text" @bind="currentProject.ImageUrl" placeholder="https://example.com/image.jpg" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ekran Görüntüleri -->
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="bi bi-images me-2"></i>Ekran Görüntüleri</label>
                                <div class="screenshots-container">
                                    @if (screenshotsList.Any())
                                    {
                                        <div class="screenshots-grid">
                                            @foreach (var (screenshot, index) in screenshotsList.Select((s, i) => (s, i)))
                                            {
                                                <div class="screenshot-item">
                                                    <img src="@screenshot" alt="Ekran Görüntüsü @(index + 1)" />
                                                    <button type="button" class="remove-screenshot-btn" @onclick="() => RemoveScreenshot(index)" title="Kald?r">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    }
                                    <div class="upload-area small @(isUploadingScreenshot ? "uploading" : "")">
                                        <InputFile OnChange="HandleScreenshotUpload" accept="image/*" multiple class="file-input" id="screenshotUpload" disabled="@isUploadingScreenshot" />
                                        <label for="screenshotUpload" class="upload-label">
                                            @if (isUploadingScreenshot)
                                            {
                                                <div class="upload-spinner"></div>
                                                <span>Yükleniyor...</span>
                                            }
                                            else
                                            {
                                                <i class="bi bi-plus-lg"></i>
                                                <span>Ekran Görüntüsü Ekle</span>
                                            }
                                        </label>
                                    </div>
                                    <div class="screenshots-url-input">
                                        <input type="text" @bind="newScreenshotUrl" placeholder="Ekran görüntüsü URL'si" />
                                        <button type="button" class="add-url-btn" @onclick="AddScreenshotUrl" disabled="@string.IsNullOrWhiteSpace(newScreenshotUrl)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Teknolojiler (virgülle ay?r?n)</label>
                                <input type="text" @bind="technologiesInput" placeholder="C#, .NET, Blazor" />
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Özellikler (virgülle ay?r?n)</label>
                                <textarea @bind="featuresInput" rows="2" placeholder="Özellik 1, Özellik 2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn-secondary" @onclick="CloseModal">?ptal</button>
                        <button class="btn-primary" @onclick="SaveProject" disabled="@isUploading">
                            <i class="bi bi-check-lg me-2"></i>@(isEditing ? "Güncelle" : "Ekle")
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Toast Notification -->
        @if (showToast)
        {
            <div class="toast @toastType">
                <i class="bi @(toastType == "success" ? "bi-check-circle" : "bi-exclamation-circle") me-2"></i>
                @toastMessage
            </div>
        }
    </div>
}

<style>
    .admin-dashboard {
        min-height: 100vh;
        background: linear-gradient(135deg, #0a0f1e 0%, #1a1f35 100%);
    }

    .loading-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #0a0f1e 0%, #1a1f35 100%);
    }

    .spinner-large {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(99, 102, 241, 0.2);
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Header */
    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        background: rgba(15, 23, 42, 0.8);
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        flex-wrap: wrap;
        gap: 1rem;
    }

    .admin-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #fff;
        margin: 0;
    }

    .header-center {
        display: flex;
        align-items: center;
    }

    .session-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 20px;
        color: #86efac;
        font-size: 0.85rem;
    }

    .extend-btn {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: rgba(34, 197, 94, 0.2);
        color: #86efac;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        margin-left: 0.5rem;
    }

    .extend-btn:hover {
        background: rgba(34, 197, 94, 0.3);
        transform: rotate(180deg);
    }

    .header-right {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    /* Buttons */
    .btn-primary, .btn-secondary, .btn-danger {
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        border: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        color: #a5b4fc;
    }

    .btn-secondary:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    .btn-danger {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    /* Main Content */
    .admin-main {
        padding: 2rem;
    }

    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .project-count {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9rem;
    }

    /* Table */
    .table-container {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        border: 1px solid rgba(99, 102, 241, 0.1);
        overflow: hidden;
    }

    .projects-table {
        width: 100%;
        border-collapse: collapse;
    }

    .projects-table th {
        padding: 1rem 1.25rem;
        text-align: left;
        background: rgba(15, 23, 42, 0.5);
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .projects-table td {
        padding: 1rem 1.25rem;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
        color: #fff;
        font-size: 0.9rem;
    }

    .projects-table tbody tr:hover {
        background: rgba(99, 102, 241, 0.05);
    }

    .id-cell {
        width: 60px;
        color: rgba(255, 255, 255, 0.5);
    }

    .project-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .project-thumb {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 8px;
    }

    .category-badge {
        padding: 4px 12px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 20px;
        color: #a5b4fc;
        font-size: 0.8rem;
    }

    .actions-cell {
        width: 100px;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        margin-right: 0.5rem;
    }

    .btn-icon.edit {
        background: rgba(99, 102, 241, 0.1);
        color: #a5b4fc;
    }

    .btn-icon.edit:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    .btn-icon.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #fca5a5;
    }

    .btn-icon.delete:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    /* Loading & Empty States */
    .loading-state, .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .loading-state .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(99, 102, 241, 0.2);
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 1rem;
    }

    .empty-state i {
        font-size: 4rem;
        color: rgba(99, 102, 241, 0.3);
        margin-bottom: 1rem;
        display: block;
    }

    .empty-state h3 {
        color: #fff;
        margin-bottom: 0.5rem;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-content {
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 16px;
        width: 100%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
    }

    .modal-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #fff;
        margin: 0;
    }

    .modal-close {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: none;
        background: rgba(239, 68, 68, 0.1);
        color: #fca5a5;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-row {
        margin-bottom: 1rem;
    }

    .form-row.two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group label {
        display: block;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 8px;
        color: #fff;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: rgba(99, 102, 241, 0.5);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }

    /* Image Upload Styles */
    .image-upload-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .image-preview-wrapper {
        position: relative;
        display: inline-block;
        max-width: 200px;
    }

    .image-preview {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 12px;
        border: 2px solid rgba(99, 102, 241, 0.3);
    }

    .remove-image-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }

    .remove-image-btn:hover {
        transform: scale(1.1);
    }

    .upload-area {
        position: relative;
        border: 2px dashed rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(99, 102, 241, 0.05);
    }

    .upload-area:hover {
        border-color: rgba(99, 102, 241, 0.5);
        background: rgba(99, 102, 241, 0.1);
    }

    .upload-area.uploading {
        border-color: rgba(34, 197, 94, 0.5);
        background: rgba(34, 197, 94, 0.1);
    }

    .upload-area.small {
        padding: 1rem;
    }

    .file-input {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
    }

    .file-input:disabled {
        cursor: not-allowed;
    }

    .upload-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        color: #a5b4fc;
        cursor: pointer;
    }

    .upload-label i {
        font-size: 2rem;
    }

    .upload-area.small .upload-label i {
        font-size: 1.5rem;
    }

    .upload-label small {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.75rem;
    }

    .upload-spinner {
        width: 24px;
        height: 24px;
        border: 2px solid rgba(34, 197, 94, 0.2);
        border-top-color: #22c55e;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .image-url-input {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .or-divider {
        text-align: center;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.8rem;
        position: relative;
    }

    .or-divider::before,
    .or-divider::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 40%;
        height: 1px;
        background: rgba(99, 102, 241, 0.2);
    }

    .or-divider::before {
        left: 0;
    }

    .or-divider::after {
        right: 0;
    }

    /* Screenshots Styles */
    .screenshots-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .screenshots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.75rem;
    }

    .screenshot-item {
        position: relative;
        aspect-ratio: 16/9;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .screenshot-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-screenshot-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: none;
        background: rgba(239, 68, 68, 0.9);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .screenshot-item:hover .remove-screenshot-btn {
        opacity: 1;
    }

    .screenshots-url-input {
        display: flex;
        gap: 0.5rem;
    }

    .screenshots-url-input input {
        flex: 1;
    }

    .add-url-btn {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .add-url-btn:hover:not(:disabled) {
        transform: scale(1.05);
    }

    .add-url-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1.5rem;
        border-top: 1px solid rgba(99, 102, 241, 0.1);
    }

    /* Toast */
    .toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        color: #fff;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        z-index: 1001;
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%;
    }

    .toast.error {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .admin-header {
            padding: 1rem;
        }

        .admin-header h1 {
            font-size: 1.25rem;
        }

        .header-center {
            order: 3;
            width: 100%;
            justify-content: center;
        }

        .admin-main {
            padding: 1rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .projects-table {
            min-width: 600px;
        }

        .form-row.two-col {
            grid-template-columns: 1fr;
        }

        .modal-content {
            margin: 0.5rem;
        }

        .screenshots-grid {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
    }
</style>

@code {
    private bool isAuthenticated = false;
    private List<ProjectDetail>? projects;
    private bool showModal = false;
    private bool isEditing = false;
    private ProjectDetail currentProject = new ProjectDetail();
    private string technologiesInput = "";
    private string featuresInput = "";
    
    private bool showToast = false;
    private string toastMessage = "";
    private string toastType = "success";

    private int remainingMinutes = 0;
    private Timer? sessionTimer;

    // Image upload fields
    private string? imagePreview;
    private bool isUploading = false;
    private bool isUploadingScreenshot = false;
    private List<string> screenshotsList = new();
    private string newScreenshotUrl = "";
    private const long MaxFileSize = 5 * 1024 * 1024; // 5MB

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AdminService.IsAuthenticatedAsync();
        
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/admin");
            return;
        }

        remainingMinutes = AdminService.GetRemainingSessionMinutes();
        await LoadProjects();

        sessionTimer = new Timer(async _ =>
        {
            var stillAuth = await AdminService.IsAuthenticatedAsync();
            if (!stillAuth)
            {
                await InvokeAsync(() =>
                {
                    Navigation.NavigateTo("/admin");
                });
                return;
            }

            remainingMinutes = AdminService.GetRemainingSessionMinutes();
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));
    }

    private async Task ExtendSession()
    {
        await AdminService.ExtendSessionAsync();
        remainingMinutes = AdminService.GetRemainingSessionMinutes();
        ShowToast("Oturum süresi uzat?ld?.", "success");
    }

    public void Dispose()
    {
        sessionTimer?.Dispose();
    }

    private async Task LoadProjects()
    {
        projects = await AdminService.GetProjectsAsync();
    }

    private void ShowAddModal()
    {
        isEditing = false;
        currentProject = new ProjectDetail
        {
            Technologies = Array.Empty<string>(),
            Features = Array.Empty<string>(),
            Screenshots = Array.Empty<string>()
        };
        technologiesInput = "";
        featuresInput = "";
        imagePreview = null;
        screenshotsList = new List<string>();
        newScreenshotUrl = "";
        showModal = true;
    }

    private void ShowEditModal(ProjectDetail project)
    {
        isEditing = true;
        currentProject = new ProjectDetail
        {
            Id = project.Id,
            Title = project.Title,
            ShortDescription = project.ShortDescription,
            FullDescription = project.FullDescription,
            Category = project.Category,
            ImageUrl = project.ImageUrl,
            GitHubUrl = project.GitHubUrl,
            ProjectUrl = project.ProjectUrl,
            Technologies = project.Technologies ?? Array.Empty<string>(),
            Features = project.Features ?? Array.Empty<string>(),
            Screenshots = project.Screenshots ?? Array.Empty<string>(),
            CreatedDate = project.CreatedDate,
            Challenges = project.Challenges,
            Solutions = project.Solutions
        };
        technologiesInput = string.Join(", ", currentProject.Technologies);
        featuresInput = string.Join(", ", currentProject.Features);
        imagePreview = null;
        screenshotsList = currentProject.Screenshots?.ToList() ?? new List<string>();
        newScreenshotUrl = "";
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
        imagePreview = null;
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        
        if (file.Size > MaxFileSize)
        {
            ShowToast("Dosya boyutu 5MB'dan küçük olmal?d?r.", "error");
            return;
        }

        if (!file.ContentType.StartsWith("image/"))
        {
            ShowToast("Lütfen geçerli bir görsel dosyas? seçin.", "error");
            return;
        }

        isUploading = true;
        StateHasChanged();

        try
        {
            using var stream = file.OpenReadStream(MaxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var bytes = memoryStream.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            imagePreview = $"data:{file.ContentType};base64,{base64}";
            currentProject.ImageUrl = imagePreview;
            ShowToast("Görsel ba?ar?yla yüklendi.", "success");
        }
        catch (Exception ex)
        {
            ShowToast($"Görsel yüklenirken hata olu?tu: {ex.Message}", "error");
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private async Task HandleScreenshotUpload(InputFileChangeEventArgs e)
    {
        isUploadingScreenshot = true;
        StateHasChanged();

        try
        {
            foreach (var file in e.GetMultipleFiles(10))
            {
                if (file.Size > MaxFileSize)
                {
                    ShowToast($"{file.Name} dosyas? çok büyük. Atlan?yor...", "error");
                    continue;
                }

                if (!file.ContentType.StartsWith("image/"))
                {
                    continue;
                }

                using var stream = file.OpenReadStream(MaxFileSize);
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                var bytes = memoryStream.ToArray();
                var base64 = Convert.ToBase64String(bytes);
                var dataUrl = $"data:{file.ContentType};base64,{base64}";
                screenshotsList.Add(dataUrl);
            }
            ShowToast("Ekran görüntüleri yüklendi.", "success");
        }
        catch (Exception ex)
        {
            ShowToast($"Yükleme hatas?: {ex.Message}", "error");
        }
        finally
        {
            isUploadingScreenshot = false;
            StateHasChanged();
        }
    }

    private void RemoveImage()
    {
        imagePreview = null;
        currentProject.ImageUrl = "";
        StateHasChanged();
    }

    private void RemoveScreenshot(int index)
    {
        if (index >= 0 && index < screenshotsList.Count)
        {
            screenshotsList.RemoveAt(index);
            StateHasChanged();
        }
    }

    private void AddScreenshotUrl()
    {
        if (!string.IsNullOrWhiteSpace(newScreenshotUrl))
        {
            screenshotsList.Add(newScreenshotUrl.Trim());
            newScreenshotUrl = "";
            StateHasChanged();
        }
    }

    private async Task SaveProject()
    {
        if (string.IsNullOrWhiteSpace(currentProject.Title) || string.IsNullOrWhiteSpace(currentProject.ShortDescription))
        {
            ShowToast("Ba?l?k ve k?sa aç?klama zorunludur.", "error");
            return;
        }

        currentProject.Technologies = technologiesInput?
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(t => t.Trim())
            .Where(t => !string.IsNullOrEmpty(t))
            .ToArray() ?? Array.Empty<string>();

        currentProject.Features = featuresInput?
            .Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(f => f.Trim())
            .Where(f => !string.IsNullOrEmpty(f))
            .ToArray() ?? Array.Empty<string>();

        currentProject.Screenshots = screenshotsList.ToArray();

        if (isEditing)
        {
            await AdminService.UpdateProjectAsync(currentProject);
            ShowToast("Proje güncellendi.", "success");
        }
        else
        {
            await AdminService.AddProjectAsync(currentProject);
            ShowToast("Proje eklendi.", "success");
        }

        await LoadProjects();
        CloseModal();
    }

    private async Task DeleteProject(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Bu projeyi silmek istedi?inizden emin misiniz?");
        
        if (confirmed)
        {
            await AdminService.DeleteProjectAsync(id);
            await LoadProjects();
            ShowToast("Proje silindi.", "success");
        }
    }

    private async Task ExportJson()
    {
        var json = await AdminService.ExportProjectsJsonAsync();
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", json);
        ShowToast("JSON panoya kopyaland?.", "success");
    }

    private async Task ResetProjects()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Tüm de?i?iklikler silinecek ve orijinal projeler yüklenecek. Devam etmek istiyor musunuz?");
        
        if (confirmed)
        {
            await AdminService.ResetToOriginalAsync();
            await LoadProjects();
            ShowToast("Projeler s?f?rland?.", "success");
        }
    }

    private async Task Logout()
    {
        await AdminService.LogoutAsync();
        Navigation.NavigateTo("/admin");
    }

    private async void ShowToast(string message, string type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        StateHasChanged();

        await Task.Delay(3000);
        showToast = false;
        StateHasChanged();
    }
}
